<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recommended Recipes</title>
  <link rel="stylesheet" href="./css/recommend.css"> 
</head>
<body>
  <div class="container">
    <h1 id="pageTitle" data-en="Your Recommended Recipes" data-zh="您的推荐食谱"></h1>
    <div class="summary">
      <p id="tdeeLabel" data-en="Your TDEE is:" data-zh="您的TDEE是：">
        <span id="tdeeValue"></span> kcal
      </p>
      <p id="goalLabel" data-en="Your Fitness Goal is:" data-zh="你的健身目标是：">
        <span id="goalValue"></span>
      </p>
      <a href="index.html" class="back-button" data-en="Return to Home" data-zh="返回主页"></a>
    </div>

    <div class="meal-container">
      <!-- 早餐 -->
      <div class="meal-box">
        <h2 id="breakfastTitle" data-en="Breakfast" data-zh="早餐"></h2>
        <div class="calories-range">
          <p id="breakfastCalories" data-en="Recommended Calories Range:" data-zh="推荐热量范围：">
            <span id="breakfastRange"></span> kcal
          </p>
        </div>
        <div class="recipes-list" id="breakfastRecipes"></div>
      </div>

      <!-- 午餐 -->
      <div class="meal-box">
        <h2 id="lunchTitle" data-en="Lunch" data-zh="午餐"></h2>
        <div class="calories-range">
          <p id="lunchCalories" data-en="Recommended Calories Range:" data-zh="推荐热量范围：">
            <span id="lunchRange"></span> kcal
          </p>
        </div>
        <div class="recipes-list" id="lunchRecipes"></div>
      </div>

      <!-- 晚餐 -->
      <div class="meal-box">
        <h2 id="dinnerTitle" data-en="Dinner" data-zh="晚餐"></h2>
        <div class="calories-range">
          <p id="dinnerCalories" data-en="Recommended Calories Range:" data-zh="推荐热量范围：">
            <span id="dinnerRange"></span> kcal
          </p>
        </div>
        <div class="recipes-list" id="dinnerRecipes"></div>
      </div>
    </div>

    <!-- 确定选择按钮 -->
    <button id="confirmButton" data-en="Confirm Selection" data-zh="确认选择" onclick="confirmSelection()"></button>

    <!-- 选择结果弹窗 -->
    <div id="confirmationModal" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle" data-en="Final Selected Recipes" data-zh="最终选择的食谱"></h3>
        <p id="selectedRecipes"></p>
        <button id="closeButton" data-en="Close" data-zh="关闭" onclick="closeModal()"></button>
      </div>
    </div>
  </div>

  <script>
    const selectedRecipes = { breakfast: null, lunch: null, dinner: null };

    function getParameterByName(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function switchLanguage(language) {
      const elements = document.querySelectorAll('[data-en][data-zh]');
      elements.forEach(el => {
        if (el.children.length > 0) {
          // 只修改不包含动态内容的部分
          el.firstChild.nodeValue = language === 'zh' ? el.getAttribute('data-zh') : el.getAttribute('data-en');
        } else {
          el.innerText = language === 'zh' ? el.getAttribute('data-zh') : el.getAttribute('data-en');
        }
      });
    }

    async function loadRecipes() {
      const tdee = getParameterByName('tdee');
      const fitnessGoal = getParameterByName('fitnessGoal');
      const language = getParameterByName('language') || 'en';

      // 切换语言
      switchLanguage(language);

      if (tdee) {
        let totalCalories = parseInt(tdee);

        if (fitnessGoal === 'loseWeight') {
          totalCalories *= 0.8;
        } else if (fitnessGoal === 'gainMuscle') {
          totalCalories *= 1.2;
        }

        const breakfastCaloriesMin = Math.round(totalCalories * 0.25);
        const breakfastCaloriesMax = Math.round(totalCalories * 0.30);
        const lunchCaloriesMin = Math.round(totalCalories * 0.35);
        const lunchCaloriesMax = Math.round(totalCalories * 0.40);
        const dinnerCaloriesMin = Math.round(totalCalories * 0.30);
        const dinnerCaloriesMax = Math.round(totalCalories * 0.40);

        document.getElementById('tdeeValue').innerText = Math.round(totalCalories);
        document.getElementById('breakfastRange').innerText = `${breakfastCaloriesMin} - ${breakfastCaloriesMax}`;
        document.getElementById('lunchRange').innerText = `${lunchCaloriesMin} - ${lunchCaloriesMax}`;
        document.getElementById('dinnerRange').innerText = `${dinnerCaloriesMin} - ${dinnerCaloriesMax}`;

        const goalDisplay = language === 'zh' 
          ? (fitnessGoal === 'loseWeight' ? '减脂' : '增肌') 
          : (fitnessGoal === 'loseWeight' ? 'Lose Weight' : 'Gain Muscle');
        document.getElementById('goalValue').innerText = goalDisplay;

        await loadMealSuggestions('breakfast', breakfastCaloriesMin, breakfastCaloriesMax);
        await loadMealSuggestions('lunch', lunchCaloriesMin, lunchCaloriesMax);
        await loadMealSuggestions('dinner', dinnerCaloriesMin, dinnerCaloriesMax);
      } else {
        document.querySelector('.summary').innerHTML = language === 'zh' 
          ? '<p>错误：未提供 TDEE 值。</p>' 
          : '<p>Error: No TDEE value provided.</p>';
      }
    }

    async function loadMealSuggestions(mealType, minCalories, maxCalories) {
      const response = await fetch(`/get-recipes?mealType=${mealType}&minCalories=${minCalories}&maxCalories=${maxCalories}`);
      const recipes = await response.json();
      const recipesList = document.getElementById(`${mealType}Recipes`);

      recipes.forEach(recipe => {
        const recipeItem = document.createElement('button');
        recipeItem.classList.add('recipe-item');
        recipeItem.innerHTML = `<p>${recipe.name} - ${Math.round(recipe.calories)} kcal</p>`;
        
        recipeItem.onclick = () => toggleSelection(mealType, recipe.name, recipeItem);

        recipesList.appendChild(recipeItem);
      });
    }

    function toggleSelection(mealType, recipeName, element) {
      if (element.classList.contains("selected")) {
        element.classList.remove("selected");
        selectedRecipes[mealType] = null;
      } else {
        const previouslySelected = document.querySelector(`#${mealType}Recipes .selected`);
        if (previouslySelected) {
          previouslySelected.classList.remove("selected");
        }
        element.classList.add("selected");
        selectedRecipes[mealType] = recipeName;
      }
    }

    function confirmSelection() {
  const language = getParameterByName('language') || 'en';
  const mealLabels = {
    breakfast: language === 'zh' ? '早餐' : 'Breakfast',
    lunch: language === 'zh' ? '午餐' : 'Lunch',
    dinner: language === 'zh' ? '晚餐' : 'Dinner',
  };

  if (selectedRecipes.breakfast && selectedRecipes.lunch && selectedRecipes.dinner) {
    const confirmationText = `
      ${mealLabels.breakfast}: ${selectedRecipes.breakfast} <br>
      ${mealLabels.lunch}: ${selectedRecipes.lunch} <br>
      ${mealLabels.dinner}: ${selectedRecipes.dinner}
    `;
    document.getElementById("selectedRecipes").innerHTML = confirmationText;
    document.getElementById("confirmationModal").style.display = "block";
  } else {
    alert(language === 'zh' 
      ? "请为每顿饭选择一个食谱。" 
      : "Please select one recipe for each meal.");
  }
}


    function closeModal() {
      document.getElementById("confirmationModal").style.display = "none";
    }

    window.onload = loadRecipes;
  </script>
</body>
</html>
