<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recommended Recipes</title>
  <link rel="stylesheet" href="./css/recommend.css"> 
</head>
<body>
  <div class="container">
    <h1>Your Recommended Recipes</h1>
    <div class="summary">
      <p>Your TDEE is: <span id="tdeeValue"></span> kcal</p>
      <p>Your Fitness Goal is: <span id="goalValue"></span></p>
      <a href="index.html" class="back-button">Return to Home</a>
    </div>

    <div class="meal-container">
      <!-- 早餐 -->
      <div class="meal-box">
        <h2>Breakfast</h2>
        <div class="calories-range">
          <p>Recommended Calories Range: <span id="breakfastRange"></span> kcal</p>
        </div>
        <div class="recipes-list" id="breakfastRecipes"></div>
      </div>
      
      <!-- 午餐 -->
      <div class="meal-box">
        <h2>Lunch</h2>
        <div class="calories-range">
          <p>Recommended Calories Range: <span id="lunchRange"></span> kcal</p>
        </div>
        <div class="recipes-list" id="lunchRecipes"></div>
      </div>
      
      <!-- 晚餐 -->
      <div class="meal-box">
        <h2>Dinner</h2>
        <div class="calories-range">
          <p>Recommended Calories Range: <span id="dinnerRange"></span> kcal</p>
        </div>
        <div class="recipes-list" id="dinnerRecipes"></div>
      </div>
    </div>

    <!-- 确定选择按钮 -->
    <button onclick="confirmSelection()">Confirm Selection</button>

    <!-- 选择结果弹窗 -->
    <div id="confirmationModal" class="modal">
      <div class="modal-content">
        <h3>Final Selected Recipes</h3>
        <p id="selectedRecipes"></p>
        <button onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    const selectedRecipes = { breakfast: null, lunch: null, dinner: null };

    function getParameterByName(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    async function loadRecipes() {
      const tdee = getParameterByName('tdee');
      const fitnessGoal = getParameterByName('fitnessGoal'); 

      if (tdee) {
        let totalCalories = parseInt(tdee);

        if (fitnessGoal === 'loseWeight') {
          totalCalories *= 0.8;
        } else if (fitnessGoal === 'gainMuscle') {
          totalCalories *= 1.2;
        }

        const breakfastCaloriesMin = Math.round(totalCalories * 0.25);
        const breakfastCaloriesMax = Math.round(totalCalories * 0.30);
        const lunchCaloriesMin = Math.round(totalCalories * 0.35);
        const lunchCaloriesMax = Math.round(totalCalories * 0.40);
        const dinnerCaloriesMin = Math.round(totalCalories * 0.30);
        const dinnerCaloriesMax = Math.round(totalCalories * 0.40);

        document.getElementById('tdeeValue').innerText = Math.round(totalCalories);
        document.getElementById('breakfastRange').innerText = `${breakfastCaloriesMin} - ${breakfastCaloriesMax}`;
        document.getElementById('lunchRange').innerText = `${lunchCaloriesMin} - ${lunchCaloriesMax}`;
        document.getElementById('dinnerRange').innerText = `${dinnerCaloriesMin} - ${dinnerCaloriesMax}`;

        let goalDisplay = fitnessGoal.charAt(0).toUpperCase() + fitnessGoal.slice(1).replace(/([A-Z])/g, ' $1');
        document.getElementById('goalValue').innerText = goalDisplay;

        await loadMealSuggestions('breakfast', breakfastCaloriesMin, breakfastCaloriesMax);
        await loadMealSuggestions('lunch', lunchCaloriesMin, lunchCaloriesMax);
        await loadMealSuggestions('dinner', dinnerCaloriesMin, dinnerCaloriesMax);
      } else {
        document.getElementById('recommendations').innerHTML = `<p>Error: No TDEE value provided.</p>`;
      }
    }

    async function loadMealSuggestions(mealType, minCalories, maxCalories) {
      const response = await fetch(`/get-recipes?mealType=${mealType}&minCalories=${minCalories}&maxCalories=${maxCalories}`);
      const recipes = await response.json();
      const recipesList = document.getElementById(`${mealType}Recipes`);

      recipes.forEach(recipe => {
        const recipeItem = document.createElement('button');
        recipeItem.classList.add('recipe-item');
        recipeItem.innerHTML = `<p>${recipe.name} - ${Math.round(recipe.calories)} kcal</p>`;
        
        recipeItem.onclick = () => toggleSelection(mealType, recipe.name, recipeItem);

        recipesList.appendChild(recipeItem);
      });
    }

    function toggleSelection(mealType, recipeName, element) {
      if (element.classList.contains("selected")) {
        element.classList.remove("selected");
        selectedRecipes[mealType] = null;
      } else {
        const previouslySelected = document.querySelector(`#${mealType}Recipes .selected`);
        if (previouslySelected) {
          previouslySelected.classList.remove("selected");
        }
        element.classList.add("selected");
        selectedRecipes[mealType] = recipeName;
      }
    }

    function confirmSelection() {
      if (selectedRecipes.breakfast && selectedRecipes.lunch && selectedRecipes.dinner) {
        const confirmationText = `
          Breakfast: ${selectedRecipes.breakfast} <br>
          Lunch: ${selectedRecipes.lunch} <br>
          Dinner: ${selectedRecipes.dinner}
        `;
        document.getElementById("selectedRecipes").innerHTML = confirmationText;
        document.getElementById("confirmationModal").style.display = "block";
      } else {
        alert("Please select one recipe for each meal.");
      }
    }

    function closeModal() {
      document.getElementById("confirmationModal").style.display = "none";
    }

    window.onload = loadRecipes;
  </script>

</body>
</html>
